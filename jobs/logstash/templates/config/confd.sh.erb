#!/usr/bin/env bash
#
set -e # exit immediately if a simple command exits with a non-zero status

# WARN: execute this script on the pipelines folder, where a new folder
# for each pipeline will be created wich a configuration file inside.
# Also all environment variables will be resolved. If you want to force them
# to be resolved by logstash, please scape them.

# Pipelines
<% p("logstash.pipelines", []).each do |pipeline| %>
# Delete all configuration and recreate it
rm -rf "<%= pipeline["name"] %>"
mkdir -p "<%= pipeline["name"] %>"
# Add all configs
  <% pipeline["config"].each do |key, content| %>
    <% if nil != content && content != '' %>
      <% if content.start_with? '/var/vcap' %>
# Link to another job/package
ln -sf "<%= content %>"
      <% else %>
cat <<'PIPELINECFG' > '<%= pipeline["name"] %>/<%= key %>.conf'
<%= content %>
PIPELINECFG
      <% end %>
    <% end %>
  <% end %>
<% end %>

