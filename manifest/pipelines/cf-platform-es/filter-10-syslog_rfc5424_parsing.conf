##------------------------
# standard rfc5424 parsing
##------------------------

# NOTE: All parsed data should include @message, @level and @source.component.
# Otherwise these fields are set from syslog_ fields in teardown script afterwards.

filter {
    grok {
      match => [ "@message", "%{SYSLOG5424LINE}" ]
      add_tag => [ "syslog_standard" ]
      add_field => { "@raw" => "%{@message}"}
      tag_on_failure => ["fail/syslog_standard/_grokparsefailure"]
    }

    syslog_pri { 
        syslog_pri_field_name => "syslog5424_pri"
    }

    date {
        match => [ "syslog5424_ts", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601" ]
        timezone => "UTC"
        remove_field => "syslog5424_ts"
    }

    mutate {
        # Populate @source.host
        add_field => [ "[@source][host]", "%{syslog5424_host}" ]
        convert => [ "syslog5424_ver", "integer" ]
    }

    # Extract instance metadata from structured data
    grok {
        match => [ "syslog5424_sd", "\[%{DATA:syslog_sd_id} (?<syslog_sd_params_raw]>[^\]]+)\]" ]
        remove_field => [
            "syslog5424_sd"
        ]
        tag_on_failure => [ "fail/syslog_standard/_grokparsefailure-syslog_standard-5424/sds" ]
    }
    if !("fail/syslog_standard/_grokparsefailure-syslog_standard-5424/sd" in [tags]) {
        # Convert the the key-value pairs
        kv {
            source => "syslog_sd_params_raw"
            target => "syslog_sd_params"
            remove_field => [
                "syslog_sd_params_raw"
            ]
        }
        # When an additional host is specified in the sd_params, promote syslog_hostname to @shipper.host
        # and replace @source.host with sd_params.host
        if [syslog_sd_params][host] {
          mutate {
            add_field => { "[@shipper][host]" => "%{[syslog5424_host]}" }
            replace => { "[@source][host]" => "%{[syslog_sd_params][host]}" }
          }
        }
        if [syslog_sd_params][type] {
           # when the syslog params include a type, prepare the message for parsing by additional downstream parsing rules:
           #  - Change the @type - this triggers downstream parsing rules
           #  - @message_body = 'unparsed' message body that will be parsed by downstream @type rules
           mutate {
               replace => { "@type" => "%{syslog_sd_params[type]}" }
           }
        }
    }


    # @message should contain the remaining unparsed text
    mutate {
        rename => { "syslog5424_msg" => "@message" }
    }

    if ![@type] {
      mutate {
        add_field => [ "@type", "unknown" ]
      }
    }
}

